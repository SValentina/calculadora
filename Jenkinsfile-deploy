pipeline {
  
  agent { dockerfile true }
  
  stages {    
    stage('Deploy Dev') {
      steps {            
        withCredentials(bindings: [azureServicePrincipal('azuredevops_dev')]) {
          sh "sed -i 's/%BUILD_NUMBER%/${BUILD_NUMBER}/g' kubernetes/deployment.yml"
          sh 'az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET -t $AZURE_TENANT_ID'  
          sh 'az aks get-credentials --resource-group $RESOURCE_GROUP --name $CLUSTER_NAME'  
          sh 'kubectl apply -k kubernetes/.'        
        }      
      }
    }          
  }

  parameters {
    string(name: 'RESOURCE_GROUP', defaultValue: 'SOCIUSRGLAB-RG-MODELODEVOPS-AKS', description: 'Grupo de Recursos') 
    string(name: 'CLUSTER_NAME', defaultValue: 'ModeloDevOps-AKS', description: 'Nombre del App Service')      
    string(name: 'BUILD_NUMBER', defaultValue: '', description: 'Nombre de la ejecuci√≥n de pipeline de CI') 
  }
}
